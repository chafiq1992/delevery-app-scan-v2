<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:sans-serif;background:linear-gradient(to bottom,#f5f7fa,#e2e8f0);min-height:100vh;margin:0;}
    .tab{padding:0.75rem 1rem;cursor:pointer;font-weight:600;}
    .tab.active{background:#2563eb;color:white;border-radius:0.5rem 0.5rem 0 0;}
    .tab-content{display:none;padding:1rem;}
    .tab-content.active{display:block;}
  </style>
</head>
<body class="text-gray-800">
  <div class="bg-white shadow p-4 flex justify-between items-center">
    <div class="text-2xl font-bold text-blue-700">Admin Dashboard</div>
    <div class="flex items-center space-x-2">
      <input type="date" id="startDate" class="border p-1 rounded" />
      <span>to</span>
      <input type="date" id="endDate" class="border p-1 rounded" />
      <button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="loadOverview()">Apply</button>
    </div>
  </div>

  <div class="flex space-x-2 bg-gray-100 p-2 sticky top-0 z-10">
    <div class="tab active" data-tab="overview" onclick="activateTab('overview')">Statistics Overview</div>
    <div class="tab" data-tab="placeholder" onclick="activateTab('placeholder')">Other</div>
  </div>

  <div id="overview" class="tab-content active">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-4" id="cashCards">
      <div class="bg-green-100 text-green-700 p-4 rounded shadow">
        <div class="text-sm">Total Cash Collected</div>
        <div class="text-2xl font-bold" id="cashCollected">0</div>
      </div>
      <div class="bg-yellow-100 text-yellow-700 p-4 rounded shadow">
        <div class="text-sm">Total Cash Pending</div>
        <div class="text-2xl font-bold" id="cashPending">0</div>
      </div>
      <div class="bg-red-100 text-red-700 p-4 rounded shadow">
        <div class="text-sm">Cash Lost on Failed</div>
        <div class="text-2xl font-bold" id="cashFailed">0</div>
      </div>
    </div>

    <div class="max-w-xl mx-auto">
      <canvas id="deliveryChart" style="height:300px"></canvas>
    </div>

    <div class="grid grid-cols-2 gap-4 my-4" id="parcelSummary">
      <div class="bg-blue-100 text-blue-700 p-4 rounded shadow text-center">
        <div class="text-sm">Total Dispatched Parcels</div>
        <div class="text-2xl font-bold" id="totalDispatched">0</div>
      </div>
      <div class="bg-green-100 text-green-700 p-4 rounded shadow text-center">
        <div class="text-sm">Total Delivered Parcels</div>
        <div class="text-2xl font-bold" id="totalDelivered">0</div>
      </div>
    </div>

    <div id="driversContainer" class="grid md:grid-cols-2 gap-4"></div>
  </div>

  <div id="placeholder" class="tab-content">
    <p class="text-center text-gray-500">More features coming soon...</p>
  </div>

<script>
function formatDate(d){return d.toISOString().split('T')[0];}
function computeDefaultDates(){
  const now=new Date();
  const end=new Date(now.getTime()-3*86400000);
  const start=new Date(end.getTime()-29*86400000);
  return{start:formatDate(start),end:formatDate(end)};
}
function activateTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelector(`[data-tab="${id}"]`).classList.add('active');
  document.getElementById(id).classList.add('active');
}
async function loadOverview(){
  const s=document.getElementById('startDate').value;
  const e=document.getElementById('endDate').value;
  let url='/admin/stats';
  if(s&&e)url+=`?start=${s}&end=${e}`;else url+='?days=30';
  const stats=await fetch(url).then(r=>r.json());
  const drivers=await fetch('/drivers').then(r=>r.json());
  let total={delivered:0,failed:0,dispatched:0,inprog:0,collected:0,pending:0,failedCash:0,orders:0};
  const driverEls=[];
  for(const d of drivers){
    const s=stats[d]||{};
    const orders=await fetch(`/orders?driver=${d}`).then(r=>r.json()).catch(()=>[]);
    let dispatched=0,inprog=0,pendingCash=0;
    orders.forEach(o=>{
      if((o.deliveryStatus||'')==='Dispatched')dispatched++;else inprog++;pendingCash+=parseFloat(o.cashAmount)||0;});
    const delivered=s.delivered||0, returned=s.returned||0;
    const rate=s.totalOrders?((delivered/(s.totalOrders))*100).toFixed(1):'0';
    driverEls.push(`<div class="bg-white p-4 rounded shadow"><div class="font-semibold mb-2">${d}</div><div class="text-sm">Delivered: <span class="text-green-600 font-bold">${delivered}</span> / Failed: <span class="text-red-600 font-bold">${returned}</span></div><div class="mt-1"><span class="text-sm">Success Rate:</span> <span class="font-bold ${rate>=80?'text-green-600':rate>=50?'text-yellow-600':'text-red-600'}">${rate}%</span></div></div>`);
    total.delivered+=delivered;
    total.failed+=returned;
    total.orders+=s.totalOrders||0;
    total.collected+=s.totalCollect||0;
    total.failedCash+=s.canceledAmount||0;
    total.dispatched+=dispatched;
    total.inprog+=inprog;
    total.pending+=pendingCash;
  }
  document.getElementById('driversContainer').innerHTML=driverEls.join('');
  document.getElementById('cashCollected').textContent=total.collected.toFixed(2);
  document.getElementById('cashPending').textContent=total.pending.toFixed(2);
  document.getElementById('cashFailed').textContent=total.failedCash.toFixed(2);
  document.getElementById('totalDispatched').textContent=total.orders;
  document.getElementById('totalDelivered').textContent=total.delivered;
  renderDonut(total);
}
function renderDonut(t){
  const ctx=document.getElementById('deliveryChart').getContext('2d');
  if(window.delChart)window.delChart.destroy();
  window.delChart=new Chart(ctx,{type:'doughnut',data:{labels:['Delivered','Failed','Dispatched','In Progress'],datasets:[{data:[t.delivered,t.failed,t.dispatched,t.inprog],backgroundColor:['#4caf50','#f44336','#2196f3','#ff9800']} ]},options:{responsive:true,maintainAspectRatio:false}});
}
document.addEventListener('DOMContentLoaded',()=>{
  const {start,end}=computeDefaultDates();
  document.getElementById('startDate').value=start;
  document.getElementById('endDate').value=end;
  loadOverview();
});
</script>
</body>
</html>
